name: Type Safety Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  type-safety-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.21'
        
    - name: Install golangci-lint
      uses: golangci/golangci-lint-action@v9
      with:
        version: latest
        
    - name: Type Safety Linting
      run: |
        echo "üîç TYPE SAFETY VALIDATION"
        echo "Checking for type safety violations..."
        
        # 1. Check for map[string]any violations
        echo "Checking for map[string]any violations..."
        # Get files with actual map[string]any code (not comments)
        files_with_violations=$(grep -r "map\[string\]any" internal/ --include="*.go" --exclude-dir=vendor -l)
        for file in $files_with_violations; do
          # Check if file has exemption marker
          if ! grep -q "TYPE-SAFE-EXEMPT" "$file"; then
            # Check if any actual code lines contain map[string]any (excluding comments)
            if grep "map\[string\]any" "$file" | grep -v "^[[:space:]]*//"; then
              echo "‚ùå VIOLATION: map[string]any found in $file"
              exit 1
            fi
          fi
        done
        echo "‚úÖ No map[string]any violations"
        
        # 2. Check for interface{} abuse
        echo "Checking for interface{} violations..."
        # Get files with interface{} code (not comments)
        files_with_violations=$(grep -r "interface{}" internal/ --include="*.go" --exclude-dir=vendor -l)
        for file in $files_with_violations; do
          # Check if file has exemption marker
          if ! grep -q "TYPE-SAFE-EXEMPT" "$file"; then
            # Check if any actual code lines contain interface{} (excluding comments)
            if grep "interface{}" "$file" | grep -v "^[[:space:]]*//"; then
              echo "‚ùå VIOLATION: interface{} found in $file"
              exit 1
            fi
          fi
        done
        echo "‚úÖ No interface{} violations"
        
        # 3. Check for unsafe package usage
        echo "Checking for unsafe package violations..."
        # Get files with unsafe usage (not comments)
        files_with_violations=$(grep -r "unsafe\." internal/ --include="*.go" --exclude-dir=vendor -l)
        for file in $files_with_violations; do
          # Check if file has exemption marker
          if ! grep -q "TYPE-SAFE-EXEMPT" "$file"; then
            # Check if any actual code lines contain unsafe. (excluding comments)
            if grep "unsafe\." "$file" | grep -v "^[[:space:]]*//"; then
              echo "‚ùå VIOLATION: unsafe package usage found in $file"
              exit 1
            fi
          fi
        done
        echo "‚úÖ No unsafe package violations"
        
        # 4. Check for reflect package usage (requires explicit justification)
        echo "Checking for reflect package violations..."
        # Get files with reflect usage (not comments)
        files_with_violations=$(grep -r "reflect\." internal/ --include="*.go" --exclude-dir=vendor -l)
        for file in $files_with_violations; do
          # Check if file has exemption marker
          if ! grep -q "TYPE-SAFE-EXEMPT" "$file"; then
            # Check if any actual code lines contain reflect. (excluding comments)
            if grep "reflect\." "$file" | grep -v "^[[:space:]]*//"; then
              echo "‚ùå VIOLATION: reflect package usage found in $file"
              echo "If reflection is necessary, add // TYPE-SAFE-EXEMPT: <reason> comment"
              exit 1
            fi
          fi
        done
        echo "‚úÖ No reflect package violations"
        
        # 5. Check for generic usage opportunities
        echo "üîç Checking for generic opportunities..."
        
        # 6. Run golangci-lint with strict rules
        echo "üîç Running type safety focused linting..."
        golangci-lint run --timeout=5m \
          --disable-all \
          --enable=govet,goimports,gofmt,errcheck,staticcheck,unused
          
    - name: Dependency Cycle Check
      run: |
        echo "üîç CHECKING DEPENDENCY CYCLES"
        go install github.com/fzipp/gocycmd/cmd/gocycmd@latest
        if ! gocycmd ./...; then
          echo "‚ùå VIOLATION: Dependency cycle detected"
          exit 1
        fi
        echo "‚úÖ No dependency cycles"
        
    - name: Type Safety Summary
      run: |
        echo "‚úÖ TYPE SAFETY VALIDATION PASSED"
        echo "üìä Summary:"
        echo "- No map[string]any violations"
        echo "- No interface{} violations"
        echo "- No unsafe package violations"
        echo "- No reflect package violations"
        echo "- No dependency cycles"
        echo "- Code follows Type Safety First principles"